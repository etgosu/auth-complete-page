<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Pretendard", "Noto Sans KR", system-ui, sans-serif;
      background: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #c8d0e0;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h2 { margin: 0 0 8px; color: #1f2937; }
    p { margin: 0; color: #6b7280; }
  </style>
</head>
<body>
  <div class="message" id="message">
    <div class="spinner"></div>
    <h2>ì²˜ë¦¬ ì¤‘...</h2>
    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
  </div>

  <script type="module">
    // ğŸ”’ Supabase ì„¤ì •
    const SUPABASE_URL = 'https://agxskvjsoybgecjxzcyw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFneHNrdmpzb3liZ2Vjanh6Y3l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNjQ3OTksImV4cCI6MjA2MTY0MDc5OX0.c91rTzkL80pP5ehdLTnWdNAzSHkHtnDtTE-9wanbrAs';

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const messageEl = document.getElementById('message');

    const showError = (title, desc) => {
      messageEl.innerHTML = `
        <h2 style="color:#ef4444;">${title}</h2>
        <p>${desc}</p>
      `;
    };

    const init = async () => {
      const url = new URL(window.location.href);
      const type = url.searchParams.get("type");
      const code = url.searchParams.get("code");

      // 1. ê¸°ì¡´ type íŒŒë¼ë¯¸í„° ë°©ì‹ (fallback)
      if (type === "signup") {
        window.location.href = "/auth-complete-page/signup-complete.html";
        return;
      }
      if (type === "recovery") {
        window.location.href = "/auth-complete-page/reset-password.html";
        return;
      }

      // 2. PKCE íë¦„: code íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ” ê²½ìš°
      if (code) {
        try {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);

          if (error) {
            console.error('ì„¸ì…˜ êµí™˜ ì‹¤íŒ¨:', error);
            showError('ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ì…ë‹ˆë‹¤.', 'ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ ë§í¬ì…ë‹ˆë‹¤.');
            return;
          }

          // ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œì¸ì§€ ì²´í¬ (íšŒì›ê°€ì… ì´ë©”ì¼ ì¸ì¦)
          if (data.user && data.user.email_confirmed_at != null) {
            // ì„¸ì…˜ì´ ìˆê³ , recovery íƒ€ì…ì´ ì•„ë‹ˆë©´ â†’ íšŒì›ê°€ì… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ
            // recoveryì¸ ê²½ìš°ì—ë„ email_confirmed_atì´ ìˆìœ¼ë¯€ë¡œ, 
            // sessionì˜ aal(authenticator assurance level)ì´ë‚˜ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ êµ¬ë¶„
            // ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•: updateUserê°€ í—ˆìš©ë˜ëŠ”ì§€ = recovery ì„¸ì…˜
            
            // Supabase recovery ì„¸ì…˜ì€ sessionì´ ìˆê³  updateUser í˜¸ì¶œì´ ê°€ëŠ¥
            // signup ì¸ì¦ ì™„ë£ŒëŠ” email_confirmed_atì´ ë°©ê¸ˆ ì„¤ì •ë¨
            // êµ¬ë¶„ ë°©ë²•: recovery ë§í¬ëŠ” session.user.recovery_sent_atì´ ì„¤ì •ë¨
            
            // ì‹¤ìš©ì  êµ¬ë¶„: data.sessionì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ê°€ëŠ¥
            // ë¨¼ì € recoveryì¸ì§€ í™•ì¸ (sessionì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥)
            if (data.session) {
              // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€ë¡œ (ì´ë¯¸ ì„¸ì…˜ ì„¤ì •ë¨)
              window.location.href = "/auth-complete-page/reset-password.html";
              return;
            }

            // ì„¸ì…˜ ì—†ì´ email_confirmed_atë§Œ ìˆìœ¼ë©´ íšŒì›ê°€ì… ì™„ë£Œ
            window.location.href = "/auth-complete-page/signup-complete.html";
            return;
          }

          // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
          if (data.session) {
            window.location.href = "/auth-complete-page/reset-password.html";
            return;
          }

          showError('ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ì…ë‹ˆë‹¤.', 'ë§í¬ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

        } catch (err) {
          console.error('ì²˜ë¦¬ ì˜¤ë¥˜:', err);
          showError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
        return;
      }

      // 3. codeë„ typeë„ ì—†ëŠ” ê²½ìš°
      showError('ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ì…ë‹ˆë‹¤.', 'ë§í¬ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    init();
  </script>
</body>
</html>
