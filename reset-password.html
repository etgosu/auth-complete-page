<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --error: #ef4444;
      --success: #16a34a;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      font-family: "Pretendard", "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      padding: 16px;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    p.description {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 14px;
      line-height: 1.4;
      display: none;
    }

    .alert.success {
      display: block;
      border-color: rgba(22, 163, 74, 0.25);
      background: rgba(22, 163, 74, 0.08);
      color: var(--success);
    }

    .alert.error {
      display: block;
      border-color: rgba(239, 68, 68, 0.25);
      background: rgba(239, 68, 68, 0.08);
      color: var(--error);
    }

    .alert.neutral {
      display: block;
      color: var(--muted);
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="password"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
    }

    .helper {
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    button {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }

    button:hover {
      background: var(--primary-hover);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .footer-text {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <main class="card" aria-live="polite">
    <div>
      <h1>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h1>
      <p class="description">ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•œ ë’¤ ë³€ê²½ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
    </div>

    <div id="alert" class="alert" role="status"></div>

    <form id="reset-form" novalidate style="display: none;">
      <label for="password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input id="password" name="password" type="password" minlength="8" autocomplete="new-password" required placeholder="8ì ì´ìƒ ì…ë ¥" />
      <p class="helper">ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
      <button type="submit" id="submit-btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </form>

    <p id="invalid-message" class="footer-text" style="display: none;">ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì„ ìš”ì²­í•´ ì£¼ì„¸ìš”.</p>
    <p id="login-hint" class="footer-text" style="display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
  </main>

  <script type="module">
    // ğŸ”’ ì•„ë˜ ë‘ ê°’ì€ ë³¸ì¸ì˜ Supabase í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•˜ì„¸ìš”.
    // âš ï¸ ì ˆëŒ€ service_role í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ê³µê°œ ì €ì¥ì†Œì— ì˜¬ë¦´ ë•ŒëŠ” Anon Keyë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const SUPABASE_URL = 'https://YOUR-PROJECT-ID.supabase.co'; // ì—¬ê¸°ì— Supabase í”„ë¡œì íŠ¸ URL ì…ë ¥
    const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY'; // ì—¬ê¸°ì— í”„ë¡œì íŠ¸ Anon Key ì…ë ¥

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¡°ê±´ ì„¤ì • (í•„ìš” ì‹œ ìˆ˜ì • ê°€ëŠ¥)
    const MIN_PASSWORD_LENGTH = 8;

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('reset-form');
    const passwordInput = document.getElementById('password');
    const alertBox = document.getElementById('alert');
    const submitBtn = document.getElementById('submit-btn');
    const invalidMessage = document.getElementById('invalid-message');
    const loginHint = document.getElementById('login-hint');

    const setAlert = (message, type) => {
      alertBox.textContent = message;
      alertBox.className = 'alert';
      alertBox.style.display = message ? 'block' : 'none';
      if (type === 'success') {
        alertBox.classList.add('success');
      } else if (type === 'error') {
        alertBox.classList.add('error');
      } else if (type === 'neutral') {
        alertBox.classList.add('neutral');
      }
    };

    const toggleForm = (visible) => {
      form.style.display = visible ? 'block' : 'none';
    };

    const isConfigured = () => {
      const missingUrl = SUPABASE_URL.includes('YOUR-PROJECT-ID');
      const missingKey = SUPABASE_ANON_KEY === 'YOUR_ANON_KEY';
      return !(missingUrl || missingKey);
    };

    const showInvalidLink = () => {
      toggleForm(false);
      invalidMessage.style.display = 'block';
    };

    const parseHashParams = () => new URLSearchParams(window.location.hash.replace('#', ''));

    // í˜ì´ì§€ ë¡œë“œì‹œ ì„¸ì…˜ í™•ì¸: ë¹„ì •ìƒ ë§í¬ ë°©ì§€
    const ensureSession = async () => {
      if (!isConfigured()) {
        showInvalidLink();
        setAlert('Supabase URLê³¼ Anon Keyë¥¼ ë¨¼ì € êµì²´í•´ ì£¼ì„¸ìš”.', 'error');
        return false;
      }

      const params = parseHashParams();
      const type = params.get('type');
      const accessToken = params.get('access_token');
      const refreshToken = params.get('refresh_token');

      if (type !== 'recovery' || !accessToken || !refreshToken) {
        showInvalidLink();
        setAlert('', '');
        return false;
      }

      try {
        setAlert('ë§í¬ ìœ íš¨ì„±ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'neutral');
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });

        if (error || !data.session) {
          showInvalidLink();
          setAlert('', '');
          return false;
        }

        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !sessionData.session) {
          showInvalidLink();
          setAlert('', '');
          return false;
        }

        toggleForm(true);
        invalidMessage.style.display = 'none';
        setAlert('', '');
        return true;
      } catch (err) {
        showInvalidLink();
        setAlert('ì„¸ì…˜ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
        return false;
      }
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const newPassword = passwordInput.value.trim();
      if (!newPassword || newPassword.length < MIN_PASSWORD_LENGTH) {
        setAlert(`ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ ${MIN_PASSWORD_LENGTH}ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
        passwordInput.focus();
        return;
      }

      submitBtn.disabled = true;
      passwordInput.disabled = true;
      try {
        setAlert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'neutral');
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) {
          setAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§í¬ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ë§í¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        } else {
          setAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì•ˆì „í•˜ê²Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loginHint.style.display = 'block';
          form.reset();
          await supabase.auth.signOut();
        }
      } catch (err) {
        setAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
      } finally {
        submitBtn.disabled = false;
        passwordInput.disabled = false;
      }
    });

    // ì´ˆê¸° ì‹¤í–‰
    ensureSession();
  </script>
</body>
</html>
